name: Build Harbor ARM64 Images

on:
  workflow_dispatch:
    inputs:
      use_buildx:
        description: '是否使用Buildx(x86环境只能true)'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
      image_name:
        description: '镜像名称'
        required: true
        default: 'harbor_aarch64_images'
      docker_project:
        description: 'Docker项目名称(通常是docker hub 用户名)'
        required: true
        default: 'liulik'
      harbor_image_tag:
        description: 'Harbor镜像TAG(构建镜像使用)'
        required: true
        default: 'v2.14.0'
      harbor_tag:
        description: 'Harbor TAG(拉取Harbor源代码使用)'
        required: true
        default: 'v2.14.0'
      create_release:
        description: '是否创建GitHub Release'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      release_tag:
        description: 'Release标签'
        required: false
        default: 'v2.14.0'
      overwrite_release:
        description: '是否覆盖已存在的Release'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      release_config:
        description: 'Release配置 (格式: name:自定义名称,draft:false,prerelease:false,make_latest:false,notes:自定义说明)'
        required: false
        type: string
        default: 'name:,draft:false,prerelease:false,make_latest:false,notes:'

env:
  USE_BUILDX: ${{ inputs.use_buildx }}
  IMAGE_NAME: ${{ inputs.image_name }}
  DOCKER_PROJECT: ${{ inputs.docker_project }}
  HARBOR_IMAGE_TAG: ${{ inputs.harbor_image_tag }}
  HARBOR_TAG: ${{ inputs.harbor_tag }}
  OVERWRITE_RELEASE: ${{ inputs.overwrite_release }}

jobs:
  build-harbor:
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Check and setup Docker environment
        run: |
          chmod +x .github/workflows/scripts/check-docker-env.sh
          .github/workflows/scripts/check-docker-env.sh

      - name: Clone harbor-aarch64 repository
        run: |
          set -e
          if [ -n "${{ secrets.GITEE_TOKEN }}" ]; then
            echo "Using Token Authentication For Gitee"
            git clone https://liuli-ke:${{ secrets.GITEE_TOKEN }}@gitee.com/liuli-ke/harbor-aarch64.git || {
              echo "[ERROR]: Failed to clone repository with Token Authentication"
              exit 1
            }
          else
            echo "GITEE_TOKEN not found, attempting anonymous clone"
            git clone https://gitee.com/liuli-ke/harbor-aarch64.git || {
              echo "[ERROR]: Failed to clone repository anonymously"
              echo "[Note]: Private repositories usually Require Authentication"
              exit 1
            }
          fi
          cd harbor-aarch64
          ls -l

      - name: Build Harbor images
        run: |
          cd harbor-aarch64
          chmod +x build-harbor.sh
          ./build-harbor.sh || build_status=$?
          cd  ../ && bash .github/workflows/scripts/show-images-info.sh
          # 如果构建失败，则退出并返回构建状态码
          if [ -n "${build_status:-}" ]; then
            echo "❌ Harbor 构建失败，退出码: $build_status"
            exit $build_status
          fi
        env:
          HARBOR_TAG: ${{ env.HARBOR_TAG }}
          HARBOR_IMAGE_TAG: ${{ env.HARBOR_IMAGE_TAG }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_PROJECT: ${{ env.DOCKER_PROJECT }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          USE_BUILDX: ${{ env.USE_BUILDX }}

      - name: Parse Release Config
        id: parse_release_config
        if: ${{ inputs.create_release == 'true' || env.OVERWRITE_RELEASE == 'true' }}
        run: |
          CONFIG="${{ inputs.release_config }}"
          
          # 解析 name
          if echo "$CONFIG" | grep -q 'name:[^,]*'; then
            RELEASE_NAME=$(echo "$CONFIG" | grep -o 'name:[^,]*' | cut -d':' -f2-)
            echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          else
            echo "release_name=" >> $GITHUB_OUTPUT
          fi
          
          # 解析 draft
          if echo "$CONFIG" | grep -q 'draft:[^,]*'; then
            DRAFT=$(echo "$CONFIG" | grep -o 'draft:[^,]*' | cut -d':' -f2)
            echo "draft=$DRAFT" >> $GITHUB_OUTPUT
          else
            echo "draft=false" >> $GITHUB_OUTPUT
          fi
          
          # 解析 prerelease
          if echo "$CONFIG" | grep -q 'prerelease:[^,]*'; then
            PRERELEASE=$(echo "$CONFIG" | grep -o 'prerelease:[^,]*' | cut -d':' -f2)
            echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi
          
          # 解析 make_latest
          if echo "$CONFIG" | grep -q 'make_latest:[^,]*'; then
            MAKE_LATEST=$(echo "$CONFIG" | grep -o 'make_latest:[^,]*' | cut -d':' -f2)
            echo "make_latest=$MAKE_LATEST" >> $GITHUB_OUTPUT
          else
            echo "make_latest=false" >> $GITHUB_OUTPUT
          fi
          
          # 解析 notes
          if echo "$CONFIG" | grep -q 'notes:[^,]*'; then
            NOTES=$(echo "$CONFIG" | grep -o 'notes:[^,]*' | cut -d':' -f2-)
            echo "notes=$NOTES" >> $GITHUB_OUTPUT
          else
            echo "notes=" >> $GITHUB_OUTPUT
          fi
          
          echo "Parsed release config:"
          echo "name: $RELEASE_NAME"
          echo "draft: $DRAFT"
          echo "prerelease: $PRERELEASE"
          echo "make_latest: $MAKE_LATEST"
          echo "notes: $NOTES"

      - name: Check if Release exists
        id: check_release
        if: ${{ inputs.create_release == 'true' || env.OVERWRITE_RELEASE == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const { data: release } = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: '${{ inputs.release_tag }}'
              });
              console.log(`ℹ️ Release ${{ inputs.release_tag }} exists`);
              return true;
            } catch (error) {
              if (error.status === 404) {
                console.log(`ℹ️ Release ${{ inputs.release_tag }} does not exist`);
                return false;
              }
              throw error;
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete existing Release and Tag (Overwrite mode)
        if: ${{ env.OVERWRITE_RELEASE == 'true' && inputs.create_release == 'true' && steps.check_release.outputs.result == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            try {
              // 1. 获取Release信息
              const { data: release } = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: '${{ inputs.release_tag }}'
              });

              // 2. 删除Release
              await github.rest.repos.deleteRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.id
              });
              console.log(`✅ Release ${{ inputs.release_tag }} deleted`);

              // 3. 删除关联的Git标签
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${{ inputs.release_tag }}`
              });
              console.log(`✅ Tag ${{ inputs.release_tag }} deleted`);

              return true;
            } catch (error) {
              if (error.status === 404) {
                console.log('ℹ️ No existing release or tag found, nothing to delete.');
                return false;
              }
              throw error;
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release (New or Overwrite)
        if: ${{ inputs.create_release == 'true' || (env.OVERWRITE_RELEASE == 'true' && steps.check_release.outputs.result == 'true') }}
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.release_tag }}
          name: "${{ steps.parse_release_config.outputs.release_name || inputs.release_tag }}"
          body: |
            Harbor ARM64 镜像构建结果

            **构建信息:**
            - Harbor 版本: ${{ env.HARBOR_TAG }}
            - 镜像标签: ${{ env.HARBOR_IMAGE_TAG }}
            - Docker镜像: ${{ env.DOCKER_PROJECT }}/${{ env.IMAGE_NAME }}:${{ env.HARBOR_IMAGE_TAG }}

            **包含内容:**
            - Harbor ARM64 架构的离线安装包: harbor-offline-installer-aarch64-${{ env.HARBOR_TAG }}.tgz
            
            ${{ steps.parse_release_config.outputs.notes }}
          draft: ${{ steps.parse_release_config.outputs.draft }}
          prerelease: ${{ steps.parse_release_config.outputs.prerelease }}
          make_latest: ${{ steps.parse_release_config.outputs.make_latest }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip Release (Already exists and no overwrite)
        if: ${{ inputs.create_release == 'true' && env.OVERWRITE_RELEASE == 'false' && steps.check_release.outputs.result == 'true' }}
        run: |
          echo "⚠️ Release ${{ inputs.release_tag }} already exists and overwrite is set to false"
          echo "Skipping release creation to avoid overwriting existing release"

      - name: Upload build artifacts to Release
        if: ${{ steps.create_release.outputs.upload_url != null }}
        uses: softprops/action-gh-release@v1
        with:
          files: |
            harbor-aarch64/all-in-one/harbor-offline-installer-aarch64-${{ env.HARBOR_TAG }}.tgz
          tag_name: ${{ inputs.release_tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}